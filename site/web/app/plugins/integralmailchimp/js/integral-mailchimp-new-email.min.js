var activeTinyEditor="",current_modal_id="",current_editor_id="",current_editor_wrapper_id="",current_editor_container_id="",imc_styles={},email_html="",tinymceBodyBackgroundColor="",selected_post_id="";jQuery(document).ready(function(a){"use strict";function b(b){var c=a(b).find("style").text(),d=a(b).find("[mc\\:edit]");a(b).find("a").click(function(a){a.preventDefault()}),a(d).each(function(b,d){void 0!==a(d).attr("mc:label")&&a(d).attr("mc:label")!==!1?a(d).wrap("<div></div>").parent().addClass("tinymce_enabled image").hover(function(){a(d).parent().prepend("<span class='imc_img_specs'>Use an image with the following dimensions: width = "+a(d).width()+"px, height = "+a(d).height()+"px</span>")},function(){a(this).children(".imc_img_specs").remove()}).on("click",function(){a(this).children(".imc_img_specs").remove(),l.openMediaDialog(a(d).attr("mc:edit"),a(d))}):a(d).addClass("tinymce_enabled").click(function(){var b=wp.template("imc-insert-post"),e={};if(e.i18n=i18n,e.id=a(this).attr("mc:edit"),e.current_modal_id="imc_modal_"+e.id,"object"==typeof tinyMCE&&"function"==typeof tinyMCE.execCommand){e.current_editor_id="imc_"+e.id+"_editor",e.current_editor_wrapper_id="wp-"+e.current_editor_id+"-wrap",e.current_editor_container_id="wp-"+e.current_editor_id+"-editor-container",a("body").append(b(e)),"undefined"!=typeof imc_insert_post_types_array&&a.each(imc_insert_post_types_array,function(b,c){a("#imc_post_type_select").append(a("<option></option>").text(c).val(b))}),"undefined"!=typeof imc_insert_post_array&&a.each(imc_insert_post_array,function(b,c){a("#imc_post_select").append(a("<option></option>").text(c.Name).val(c.ID))}),"undefined"!=typeof imc_insert_post_categories_array&&a.each(imc_insert_post_categories_array,function(b,c){a("#imc_post_category_select").append(a("<option></option>").text(c.Name).val(c.ID))}),a(document).on("shown.bs.modal wplink-open",function(b){a(document.body).removeClass("modal-open")}),a("button[name=imc_text_modal_submit]").on("click",function(b){if(0==tinyMCE.activeEditor.isNotDirty){var c=tinyMCE.activeEditor.getContent();c=a(c).html(),a(d).html(c);var f=a("#template_holder").contents().find("html").clone().find(".tinymce_enabled").removeClass("tinymce_enabled").end().find("#imc_styles").remove().end().html();a("#imc_content").text("<html>"+f+"</html>")}a("#"+e.current_modal_id).modal("hide")}),a("#"+e.current_modal_id).on("hide.bs.modal",function(b){if(a("#"+e.current_modal_id).remove(),"undefined"!=typeof tinyMCE)for(var c=tinyMCE.editors.length,d=c;d>0;d--)tinyMCE.editors[d-1].remove()}),tinyMCEPreInit.mceInit[e.current_editor_id]=tinyMCEPreInit.mceInit.content,tinyMCEPreInit.mceInit[e.current_editor_id].selector="#"+e.current_editor_id,tinyMCEPreInit.mceInit[e.current_editor_id].resize=!0,tinyMCEPreInit.mceInit[e.current_editor_id].wp_autoresize_on=!1,tinyMCEPreInit.mceInit[e.current_editor_id].forced_root_block=!1,tinyMCEPreInit.mceInit[e.current_editor_id].keep_styles=!1,a("#"+e.current_modal_id).modal(),i(),a("#"+e.current_editor_id+"_ifr").contents().find("style").html(c),a("#"+e.current_editor_id+"_ifr").contents().find("link[rel=stylesheet]").prop("disabled",!0).remove();try{var g=a("<div />").append(a(d).clone().removeClass("tinymce_enabled").attr("id","imc_"+e.id)).html();"TD"===a(this).prop("tagName")&&(g="<div id='imc_"+e.id+"'>"+g+"</div>"),tinyMCE.get(e.current_editor_id).setContent(g);var h="#imc_"+e.id+"{"+f(d)+"}";a(d).children().each(function(b,c){h+="#imc_"+e.id+" "+a(c).prop("tagName")+"{"+f(c)+"}"}),a("#"+e.current_editor_id+"_ifr").contents().find("body").css("background-color",tinymceBodyBackgroundColor),imc_styles[e.id]=a("<style>",{id:e.id,type:"text/css",html:h}).appendTo(a("#"+e.current_editor_id+"_ifr").contents().find("head")),tinymceBodyBackgroundColor=""}catch(j){console.log(j)}}else alert("tinyMCE Editor not available!")})})}function c(){var b=a.Deferred();return this.onload=function(){b.resolve()},b}function d(b){imc_styles.tinymce_enabled=a("<style>",{id:"imc_styles",type:"text/css",html:"                        .tinymce_enabled{position:relative;}\n                        .tinymce_enabled:hover:after{\n                        content:' ';\n                        position:absolute;\n                        width:100%;\n                        height:100%;\n                        top:0;\n                        left:0;\n                        background-color: #2ba9c0;\n                        opacity: .5;\n                        filter:alpha(opacity=50);\n                        z-index: 9999;}\n                        .imc_img_specs{\n                        position:absolute;\n                        background-color:black;\n                        color: white;\n                        padding:6px;\n                        font-size:14px;\n                        z-index: 10000;\n                        font-family: Arial, Helvetica, sans-serif;\n                        font-weight: bold;\n                        }"}).appendTo(a(b).contents().find("head"))}function e(){var e=a("#template_holder"),f=a("#imc_content").val(),g=a(e).contents().find("html").get(0);g.innerHTML=f,d(e);var h,i=a(e.contents());h=i.find("img").map(c),a.when.apply(a,h).done(function(){var c=a(e).contents().find("body").outerHeight(!0);a(e).height(c+60),a(".template.clearfix").removeClass("template-loading").height("100%"),b(g),a(e).removeClass("hidden").addClass("show")}),a(e).removeClass("hide")}function f(b){var c=!1,d="",e=new Array("background","background-color","color","font","font-family","font-size","font-style","font-variant","font-weight","line-height","list-style","margin","padding","text-align","text-decoration","text-indent","text-shadow","text-transform");if(b.currentStyle?c=b.currentStyle:window.getComputedStyle&&(c=document.defaultView.getComputedStyle(b,null)),!c)return null;for(var f in c)-1!=a.inArray(f,e)&&void 0!=c[f]&&c[f].length>0&&"object"!=typeof c[f]&&"function"!=typeof c[f]&&f!=parseInt(f)&&(d+=f+":"+c[f]+";\n ");return-1==a.inArray("backgroundColor",e)&&g(b),d}function g(b){var c=a(b).parent(),d=a(c).css("background-color");return"transparent"==d||"rgba(0, 0, 0, 0)"==d?g(c):void(tinymceBodyBackgroundColor=d)}function h(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,b||c.apply(e,f)},h=b&&!d;clearTimeout(d),d=setTimeout(g,a),h&&c.apply(e,f)}}function i(){var a,b,c,d,e;if("undefined"!=typeof tinyMCE)for(b in tinyMCEPreInit.mceInit)if("content"!==b){a=d?tinyMCEPreInit.mceInit[b]=tinyMCE.extend({},d,tinyMCEPreInit.mceInit[b]):d=tinyMCEPreInit.mceInit[b],e=tinyMCE.DOM.select("#wp-"+b+"-wrap")[0];try{tinyMCE.init(a),m=!0,window.wpActiveEditor||(window.wpActiveEditor=b)}catch(f){console.log("Error initializing tinyMCE: "),console.log(f)}}if("undefined"!=typeof quicktags){for(c in tinyMCEPreInit.qtInit)if("content"!==c)try{quicktags(tinyMCEPreInit.qtInit[c]),window.wpActiveEditor||(window.wpActiveEditor=c)}catch(f){console.log("Error initializing tinyMCE QuickTags: "),console.log(f)}}else console.log("---- quicktags() is undefined -----");if(!m)if("undefined"!=typeof jQuery)jQuery(".wp-editor-wrap").on("click.wp-editor",function(){this.id&&(window.wpActiveEditor=this.id.slice(3,-5))});else for(c in tinyMCEPreInit.qtInit)"content"!==c&&(document.getElementById("wp-"+c+"-wrap").onclick=function(){window.wpActiveEditor=this.id.slice(3,-5)})}delete postL10n.saveAlert;var j={editor:"",inputs:{},close:function(){wpLink.isMCE()?tinyMCE.get(tinyMCE.activeEditor.id).focus():(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select())),a("#wp-link-backdrop").hide(),a("#wp-link-wrap").hide(),a(document).trigger("wplink-close",a("#wp-link-wrap"))}};a.extend(wpLink,j),a('input[name="post_title"]').attr("tabindex","99").on("keydown",function(b){var c=b.keyCode||b.which;9==c&&(b.preventDefault(),setTimeout(function(){a("#imc_email_subject").focus()},500))}),a(".postbox").each(function(b,c){a(this).removeClass("postbox").addClass("stuffbox"),a(this).has(".handlediv")&&a(this).children(".handlediv").remove(),a(this).has("h3")&&a(this).children("h3").css("cursor","default")});var k=a(".template.clearfix").height();a("select.list-select").change(function(){var b=a(this).val(),c=a(this).data("ajaxAction");a("input[name=imc_from_email]").val(""),a("input[name=imc_from_name]").val(""),a(this).parent().nextAll("div.clearfix").css("position","absolute").addClass("template-loading"),a.getJSON(ajaxurl,{action:c,email_action:"load_segments_and_defaults",list_id:b,post_id:a("#post_ID").val()}).done(function(c){var d=c.lists;a("input[name=imc_from_email]").val(d.default_from_email),a("input[name=imc_from_name]").val(d.default_from_name),a("#groups_holder").html(c.groups[b].html).removeClass("hide"),a("#segments_holder").html(c.segments[b].html).removeClass("hide"),a(".template-loading").removeClass("template-loading")})}),setTimeout(function(){a("select.list-select").change(),e()},500),a("select.template-select").change(function(){if(a("div[id^='imc_modal_']").remove(),"undefined"!=typeof tinyMCE)for(var e=tinyMCE.editors.length,f=e;f>0;f--)tinyMCE.editors[f-1].remove();a("select.template-select").not(this).val("none");var g=a(this).data("ajaxAction"),h=a("#"+a(this).data("ajaxTarget"));a(h).contents().find("html").html(""),a(".template.clearfix").height(k).addClass("template-loading");var i=a(this).val();a.post(ajaxurl,{action:g,value:i},function(e){var f=a(h).contents().find("html").get(0);f.innerHTML=e.source,a("#imc_content").text(e.source),d(h);var g,i=a(h.contents());g=i.find("img").map(c),a.when.apply(a,g).done(function(){var c=a(h).contents().find("body").outerHeight(!0);a(h).height(c+60),a(".template.clearfix").removeClass("template-loading").height("100%"),b(f),a(h).removeClass("hidden").addClass("show")})})});var l={id:"",element:"",attachment:"",email_html:"",size:"",openMediaDialog:function(b,c){return this.id=b,this.element=c,this._frame?void this._frame.open():(this._frame=l.frame=wp.media({title:"Choose Image",frame:"post",library:{type:"image"},button:{text:"Choose Image"},multiple:!1,state:"insert"}),this._frame.on("ready",function(){a(".media-menu-item:last-child").remove()}),this._frame.on("insert",function(){var b=l.frame.$el.parent().find("select[name=size]").val();l.attachment=l.frame.state().get("selection").first().toJSON(),0>a.trim(l.attachment.url.length)||l.handleMediaAttachment(b)}),this._frame.on("select",function(){}),void this._frame.open())},handleMediaAttachment:function(b){a(this.element).attr("src",this.attachment.sizes[b].url),a(this.element).attr("width",this.attachment.sizes[b].width+"px").attr("alt",this.attachment.caption).attr("title",this.attachment.title),l.updatePostContent()},updatePostContent:function(){l.email_html=a("#template_holder").contents().find("html").clone(),a(l.email_html).find(".tinymce_enabled.image").children("img").unwrap(),a(l.email_html).find(".tinymce_enabled").removeClass("tinymce_enabled"),a("#imc_content").text("<html>"+a(l.email_html).html()+"</html>")}};a(document.body).on("change","#imc_post_type_select",function(b){a("#imc-spinner").addClass("is-active"),a("select, #imc_post_search").attr("disabled","disabled").addClass("disabled");var c=a(this).data("ajaxAction"),d=a(this).data("emailAction"),e=a("#imc_post_type_select").val();a("#imc_post_search").val(""),a("ul#post_search_results").html(""),a.getJSON(ajaxurl,{action:c,email_action:d,post_type:e}).done(function(b){a("#imc_post_category_select").html("");var c=!0;a.each(b.taxonomies,function(b,d){0==d.ID&&(c=!1),a("#imc_post_category_select").append(a("<option></option>").text(d.Name).val(d.ID).attr("data-tax-type",d.Type))}),a("#imc_post_category_select").change(),c&&a("#imc-insert-post-into-text").removeAttr("disabled").removeClass("disabled")})}),a(document.body).on("change","#imc_post_category_select",function(b){var c=a(this).data("ajaxAction"),d=a(this).data("emailAction"),e=a("#imc_post_type_select").val(),f=a("#imc_post_category_select option:selected").data("taxType"),g=a("#imc_post_category_select").val();a("#imc_post_search").val(""),a("ul#post_search_results").html(""),a("#imc_post_select, #imc_post_category_select, #imc-search-post, #imc-insert-post-into-text").attr("disabled","disabled").addClass("disabled"),a("#imc-insert-post-select .spinner").addClass("is-active"),a.getJSON(ajaxurl,{action:c,email_action:d,post_type:e,category_id:g,tax_type:f}).done(function(b){a("#imc_post_select").html("");var c=!0;a.each(b.posts,function(b,d){0==d.ID&&(c=!1),a("#imc_post_select").prepend(a("<option></option>").text(d.Name).val(d.ID))}),a("select, #imc_post_search").removeAttr("disabled").removeClass("disabled"),a("#imc-spinner").removeClass("is-active"),c&&a("#imc-insert-post-into-text").removeAttr("disabled").removeClass("disabled")})}),a(document.body).on("keyup","#imc_post_search",h(250,!1,function(b){var c=a(this).val();if(c.length>2){a("#imc_post_select option:selected").removeAttr("selected");var d=a(this).data("ajaxAction"),e=a("#imc_post_category_select").val(),f=a("#imc_post_type_select").val(),g=a("#imc_post_category_select option:selected").data("taxType");a("select, #imc-search-post, #imc-insert-post-into-text").attr("disabled","disabled").addClass("disabled"),a("#imc-spinner").addClass("is-active"),a.getJSON(ajaxurl,{action:d,email_action:"load_posts_by_category",post_type:f,category_id:e,tax_type:g,post_search:c}).done(function(b){var c=!0;a("#post_search_results").html(""),a.each(b.posts,function(b,d){0==d.ID?(c=!1,a("#post_search_results").append('<button type="button" class="list-group-item">'+d.Name+"</button>").show()):a("#post_search_results").append('<button type="button" class="list-group-item" data-post-id="'+d.ID+'">'+d.Name+"</button>").show()}),a("select, #imc-search-post").removeAttr("disabled").removeClass("disabled"),a("#imc-spinner").removeClass("is-active"),c&&a("#imc-insert-post-into-text").removeAttr("disabled").removeClass("disabled")})}else c.length<1&&a("#post_search_results").html("")})),a(document.body).on("click","#post_search_results button",function(b){selected_post_id=a(this).data("postId"),a("#imc_post_search").val(a(this).text()),a("#post_search_results").html(""),a("#imc_post_select").val("")}),a(document.body).on("click","#imc-insert-post-button",function(b){return b.preventDefault(),a("#imc-insert-post-select").slideToggle(),!1}),a(document.body).on("click","#imc-insert-post-into-text",function(b){b.preventDefault();var c=a(this).data("ajaxAction"),d=a(this).data("emailAction"),e=selected_post_id?selected_post_id:a("#imc_post_select").val(),f=a('input[name="imc_insert_type"]:checked').val();return e>0&&(a("#imc_post_select, #imc_post_category_select, #imc-search-post, #imc-insert-post-into-text").attr("disabled","disabled").addClass("disabled"),a("#imc-insert-post-select .spinner").addClass("is-active"),a.getJSON(ajaxurl,{action:c,email_action:d,post_id:e,post_length:f}).done(function(b){var c=b.post_content;tinyMCE.activeEditor.execCommand("mceInsertContent",!1,c),a("#post_search_results").html(""),a("#imc-search-post").val(""),a("#imc-insert-post-select").slideToggle(),a("#imc_post_select, #imc_post_category_select, #imc-search-post, #imc-insert-post-into-text").removeAttr("disabled").removeClass("disabled"),a("#imc-insert-post-select .spinner").removeClass("is-active")})),!1}),a("button.imc-email-process").click(function(b){b.preventDefault(),a("#imc-email-campaign-message").html("").addClass("template-loading").show();var c=a(this).data("ajaxAction"),d=a(this).closest("form").serialize();a.post(ajaxurl,{form_data:d,action:"ajax_save_campaign",current_action:c},function(b){var c="updated",d=null;if(b instanceof Array||b instanceof Object)for(var e in b){switch(d=null,e){case"msg":d=b[e];break;case"cid":a("input[name=imc_campaign_id]").val(b[e]);break;case"reload":setTimeout(function(){window.location=b[e]},2e3);break;default:d="<div>"+b[e]+"</div>",c="error",a("#"+e).addClass("highlight-error")}d&&a("#imc-email-campaign-message").append(d)}a("#imc-email-campaign-message").hide().removeClass("error").removeClass("updated, template-loading").addClass(c).show()})});var m=!1});